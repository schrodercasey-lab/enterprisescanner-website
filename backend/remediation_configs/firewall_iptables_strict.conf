#!/bin/bash
# Hardened iptables Configuration
# Generated: 2025-10-18T18:29:09.134871
# Hardening Level: strict

# Flush existing rules
iptables -F
iptables -X
iptables -Z

# Default policies
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Allow loopback
iptables -A INPUT -i lo -j ACCEPT

# Allow established connections
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Allow port 22
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Allow port 80
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# Allow port 443
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# Rate limiting for SSH (anti-brute force)
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --set
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 -j DROP

# Drop invalid packets
iptables -A INPUT -m conntrack --ctstate INVALID -j DROP

# Log dropped packets (optional)
# iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables_DROP: "

# Save rules
echo 'Saving iptables rules...'
iptables-save > /etc/iptables/rules.v4